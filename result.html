<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Neuroity - Your Results</title>
<style>
    /* ---------- Base ---------- */
    body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-family: "Poppins", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        padding: 20px;
        overflow-x: hidden;
        position: relative;
        background: #1a1a2e;
    }

    /* ---------- Dynamic Background ---------- */
    .background-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
    }
    .background-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0;
        transition: opacity 2s ease-in-out;
    }
    .background-image.active { opacity: 1; }
    .background-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(141, 163, 255, 0.3), rgba(200, 138, 255, 0.3));
    }

    /* ---------- Header / Logo ---------- */
    .page-logo {
        width: 65px;
        height: 65px;
        margin: 20px auto;
        background-image: url('backgrounds/zen.jpg');
        background-size: cover;
        background-position: center;
        border-radius: 50%;
        filter: drop-shadow(0 0 12px #ffffffaa);
        animation: pulse 3s ease-in-out infinite;
        cursor: pointer;
        z-index: 100;
        position: relative;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.9; }
        50% { transform: scale(1.12); opacity: 1; }
        100% { transform: scale(1); opacity: 0.9; }
    }

    /* ---------- Card ---------- */
    .card {
        background: rgba(255, 255, 255, 0.15);
        width: 90%;
        max-width: 900px;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        backdrop-filter: blur(15px);
        box-shadow: 0px 8px 32px rgba(0, 0, 0, 0.3);
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }
    h1 { margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    h2 { margin: 25px 0 15px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    h3 { color: #634aff; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

    .score-circle {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        margin: 20px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2em;
        font-weight: bold;
        background: linear-gradient(135deg, #634aff, #8da3ff);
        box-shadow: 0 15px 35px rgba(99, 74, 255, 0.4);
        position: relative;
        overflow: hidden;
    }
    .score-circle::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background: linear-gradient(45deg, #ff6b9d, #ffd93d, #6bceff, #9d4edd);
        z-index: -1;
        filter: blur(20px);
        opacity: 0.6;
    }

    .result-category {
        color: #fff;
        font-size: 1.3em;
        margin: 20px 0;
        padding: 15px;
        background: rgba(99, 74, 255, 0.3);
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }

    .category-description {
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        margin: 15px 0;
        border-left: 5px solid #634aff;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    /* ---------- Exercise / Form ---------- */
    .exercise-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    .exercise-card {
        background: rgba(255, 255, 255, 0.15);
        padding: 25px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.4s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
    }
    .exercise-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }
    .exercise-card:hover::before { left: 100%; }
    .exercise-card:hover {
        transform: translateY(-8px) scale(1.03);
        background: rgba(255, 255, 255, 0.25);
        border-color: #634aff;
        box-shadow: 0 10px 25px rgba(99, 74, 255, 0.3);
    }
    .exercise-icon { font-size: 3em; margin-bottom: 15px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); }

    .user-form {
        text-align: left;
        margin-top: 20px;
        padding: 25px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .user-form input {
        width: 100%;
        padding: 15px;
        margin: 10px 0 20px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
        transition: all 0.3s;
    }
    .user-form input:focus { outline: none; background: rgba(255, 255, 255, 0.3); box-shadow: 0 0 0 2px #634aff; }
    .user-form input::placeholder { color: rgba(255, 255, 255, 0.7); }

    button {
        width: 100%;
        padding: 18px;
        border-radius: 12px;
        border: none;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s;
        background: linear-gradient(135deg, #634aff, #8da3ff);
        color: white;
        font-weight: bold;
        margin: 12px 0;
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(99, 74, 255, 0.4);
    }
    button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: 0.5s;
    }
    button:hover::before { left: 100%; }
    button:hover { background: linear-gradient(135deg, #4d32ff, #7b95ff); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(99, 74, 255, 0.6); }
    button:active { transform: translateY(1px); }

    .hidden { display: none; }

    /* ---------- Breathing ---------- */
    .breathing-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0c2461, #1e3799);
        z-index: 2000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .breathing-background {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.3;
        z-index: -1;
    }
    .breathing-circle {
        width: 250px;
        height: 250px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(99, 74, 255, 0.9), rgba(141, 163, 255, 0.7));
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 3.5em;
        color: white;
        margin: 30px 0;
        animation: breath 8s infinite ease-in-out;
        box-shadow: 0 0 60px rgba(99, 74, 255, 0.6);
        position: relative;
        z-index: 1;
    }
    @keyframes breath {
        0%, 100% { transform: scale(0.8); box-shadow: 0 0 40px rgba(99, 74, 255, 0.4); }
        50% { transform: scale(1.5); box-shadow: 0 0 80px rgba(99, 74, 255, 0.8); }
    }
    .breathing-instruction {
        font-size: 1.8em;
        text-align: center;
        margin-bottom: 30px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        background: rgba(0,0,0,0.3);
        padding: 15px 30px;
        border-radius: 50px;
    }
    .timer {
        font-size: 2.5em;
        margin: 20px 0;
        font-family: 'Courier New', monospace;
        background: rgba(0,0,0,0.3);
        padding: 10px 30px;
        border-radius: 10px;
        letter-spacing: 3px;
    }
    .breathing-controls { display: flex; gap: 20px; margin-top: 40px; }
    .breathing-controls button { width: auto; padding: 15px 30px; border-radius: 25px; font-size: 16px; min-width: 120px; }

    /* ---------- Music Player ---------- */
    .music-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 10, 30, 0.95);
        z-index: 2000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        backdrop-filter: blur(10px);
    }
    .music-background { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.2; z-index: -1; filter: blur(5px); }
    .music-player {
        background: rgba(85, 76, 153, 0.08);
        padding: 30px;
        border-radius: 20px;
        width: 92%;
        max-width: 700px;
        text-align: center;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }
    .album-art { width: 220px; height: 220px; border-radius: 20px; margin: 0 auto 20px; overflow: hidden; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); position: relative; }
    .album-art img { width: 100%; height: 100%; object-fit: cover; }
    .music-title { font-size: 1.6em; margin-bottom: 6px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .music-artist { color: rgba(255, 255, 255, 0.9); font-size: 1.05em; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }

    .music-controls { display: flex; justify-content: center; align-items: center; gap: 25px; margin: 20px 0; }
    .control-btn {
        background: rgba(255, 255, 255, 0.12);
        border: none;
        color: white;
        font-size: 2.2em;
        cursor: pointer;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.12);
    }
    .control-btn:hover { transform: scale(1.06); box-shadow: 0 0 20px rgba(99, 74, 255, 0.4); }
    .play-btn { width: 80px; height: 80px; font-size: 1.8em; background: linear-gradient(135deg, #634aff, #8da3ff); }

    .progress-container { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.12); border-radius: 6px; margin: 18px 0 12px; cursor: pointer; position: relative; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #634aff, #8da3ff); border-radius: 6px; width: 0%; position: relative; transition: width 0.1s linear; }
    .progress-bar::after { content: ''; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; background: white; border-radius: 50%; box-shadow: 0 0 10px rgba(99, 74, 255, 0.8); }

    .time-display { display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.95em; color: rgba(255, 255, 255, 0.85); }

    .volume-container { display: flex; align-items: center; gap: 15px; margin-top: 14px; justify-content: center; }
    .volume-slider { width: 120px; height: 8px; background: rgba(255, 255, 255, 0.12); border-radius: 6px; cursor: pointer; position: relative; }
    .volume-level { height: 100%; background: #634aff; border-radius: 6px; width: 70%; }

    .close-btn {
        position: absolute;
        top: 18px;
        right: 18px;
        background: rgba(255, 255, 255, 0.08);
        border: none;
        color: white;
        font-size: 2em;
        cursor: pointer;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        z-index: 2001;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.12);
    }
    .close-btn:hover { background: rgba(255, 50, 50, 0.25); transform: rotate(90deg); }

    .track-list { margin-top: 12px; max-height: 200px; overflow-y: auto; padding-right: 8px; }
    .track-item { padding: 12px 15px; margin: 6px 0; background: rgba(255, 255, 255, 0.04); border-radius: 10px; cursor: pointer; transition: all 0.25s; border-left: 3px solid transparent; }
    .track-item:hover { background: rgba(255, 255, 255, 0.08); border-left-color: #634aff; }
    .track-item.active { background: rgba(99, 74, 255, 0.18); border-left-color: #634aff; }

    /* ---------- Visualization ---------- */
    .visualization-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 2000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .visualization-scene { width: 100%; height: 70%; position: relative; border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(0, 0, 0, 0.5); }
    .visualization-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 2s ease-in-out; }
    .visualization-image.active { opacity: 1; }
    .visualization-text { font-size: 1.2em; text-align: center; margin: 30px; padding: 20px; background: rgba(0, 0, 0, 0.5); border-radius: 15px; max-width: 850px; line-height: 1.6; color: #fff; }

    /* ---------- Feeling ---------- */
    .feeling-check { margin: 30px 0; padding: 25px; background: rgba(255, 255, 255, 0.06); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.06); }
    .feeling-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
    .feeling-btn { padding: 15px 25px; border-radius: 25px; border: none; background: rgba(255, 255, 255, 0.12); color: white; cursor: pointer; transition: all 0.3s; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
    .feeling-btn:hover { background: rgba(99, 74, 255, 0.45); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(99, 74, 255, 0.3); }
    .feedback-message { margin-top: 25px; padding: 20px; border-radius: 15px; display: none; animation: fadeIn 0.5s ease; border-left: 5px solid; }
    .positive { background: rgba(76, 175, 80, 0.12); border-left-color: #4CAF50; }
    .negative { background: rgba(244, 67, 54, 0.12); border-left-color: #F44336; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ---------- Background selector ---------- */
    .background-selector { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; gap: 10px; }
    .bg-thumbnail { width: 50px; height: 50px; border-radius: 10px; cursor: pointer; opacity: 0.8; transition: all 0.3s; border: 2px solid transparent; object-fit: cover; }
    .bg-thumbnail:hover { opacity: 1; transform: scale(1.1); }
    .bg-thumbnail.active { opacity: 1; border-color: #634aff; box-shadow: 0 0 15px rgba(99, 74, 255, 0.5); }

    /* Responsive tweaks */
    @media (max-width: 720px) {
        .music-player { padding: 20px; }
        .album-art { width: 160px; height: 160px; }
    }
</style>
</head>
<body>

<!-- Dynamic Background -->
<div class="background-container">
    <div class="background-image" id="bg1" style="background-image: url('backgrounds/beach.jpg');"></div>
    <div class="background-image" id="bg2" style="background-image: url('backgrounds/forest.jpg');"></div>
    <div class="background-image" id="bg3" style="background-image: url('backgrounds/mountain.jpg');"></div>
    <div class="background-image" id="bg4" style="background-image: url('backgrounds/lake.jpg');"></div>
    <div class="background-image" id="bg5" style="background-image: url('backgrounds/sunset.jpg');"></div>
    <div class="background-image" id="bg6" style="background-image: url('backgrounds/stars.jpg');"></div>
    <div class="background-overlay"></div>
</div>

<!-- Background Selector -->
<div class="background-selector">
    <img src="backgrounds/beach.jpg" class="bg-thumbnail" onclick="changeBackground(0)">
    <img src="backgrounds/forest.jpg" class="bg-thumbnail" onclick="changeBackground(1)">
    <img src="backgrounds/mountain.jpg" class="bg-thumbnail" onclick="changeBackground(2)">
    <img src="backgrounds/lake.jpg" class="bg-thumbnail" onclick="changeBackground(3)">
</div>

<div class="page-logo" onclick="window.location.href='questionnaire.html'"></div>

<div class="card" id="mainCard">
    <h1>Your Neuroity Results</h1>

    <div class="score-circle" id="scoreDisplay"></div>

    <div id="resultCategory" class="result-category"></div>

    <div id="categoryDescription" class="category-description"></div>

    <div class="user-form">
        <h2>Save Your Results</h2>
        <input type="text" id="userName" placeholder="Your Name" required>
        <input type="number" id="userAge" placeholder="Your Age" min="1" max="120" required>
        <button id="saveBtn" onclick="saveResults()">Save My Results & Continue</button>
    </div>

    <div id="exerciseSection" class="hidden">
        <h2>Choose Your Relaxation Exercise</h2>
        <div class="exercise-container">
            <div class="exercise-card" onclick="startBreathingExercise()">
                <div class="exercise-icon">üåÄ</div>
                <h3>Breathing Exercise</h3>
                <p>Calm your mind with guided breathing</p>
            </div>

            <div class="exercise-card" onclick="showMusicPlayer()">
                <div class="exercise-icon">üéµ</div>
                <h3>Relaxing Music</h3>
                <p>Soothing sounds to reduce stress</p>
            </div>

            <div class="exercise-card" onclick="startVisualization()">
                <div class="exercise-icon">üåå</div>
                <h3>Guided Visualization</h3>
                <p>Peaceful mental imagery journey</p>
            </div>
        </div>

        <div class="feeling-check">
            <h3>How are you feeling now?</h3>
            <div class="feeling-buttons">
                <button class="feeling-btn" onclick="recordFeeling('better')">
                    <span>üòä</span> Feeling Better
                </button>
                <button class="feeling-btn" onclick="recordFeeling('same')">
                    <span>üòê</span> About the Same
                </button>
                <button class="feeling-btn" onclick="recordFeeling('worse')">
                    <span>üòî</span> Still Stressed
                </button>
            </div>
            <div id="feedbackMessage" class="feedback-message"></div>
        </div>

        <button onclick="restartQuestionnaire()">üîÑ Retake Questionnaire</button>
        <button onclick="viewAllResults()">üìä View All Results (Admin)</button>
    </div>
</div>

<!-- Breathing Exercise Overlay -->
<div class="breathing-container" id="breathingExercise">
    <img src="backgrounds/stars.jpg" class="breathing-background" id="breathingBg">
    <div class="close-btn" onclick="closeBreathingExercise()">√ó</div>
    <h2>Breathing Exercise</h2>
    <div class="breathing-instruction" id="breathInstruction">Breathe IN</div>
    <div class="breathing-circle" id="breathCircle">
        <div id="breathText">INHALE</div>
    </div>
    <div class="timer" id="breathTimer">00:00</div>
    <div class="breathing-controls">
        <button onclick="pauseBreathing()" id="pauseBtn">‚è∏ Pause</button>
        <button onclick="resetBreathing()">üîÑ Reset</button>
        <button onclick="closeBreathingExercise()">‚úì Finish</button>
    </div>
</div>

<!-- Music Player Overlay -->
<div class="music-container" id="musicPlayer" aria-hidden="true">
    <img src="backgrounds/zen.jpg" class="music-background" id="musicBg">
    <div class="close-btn" onclick="closeMusicPlayer()">√ó</div>

    <div class="music-player">
        <div class="album-art" id="albumArt">
            <img id="albumImage" src="backgrounds/zen.jpg" alt="Album art">
        </div>

        <div class="music-info">
            <div class="music-title" id="musicTitle">Peaceful Morning</div>
            <div class="music-artist" id="musicArtist">Neuroity Relaxation</div>
        </div>

        <div class="progress-container" onclick="seekMusic(event)" aria-label="Seek bar">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
        </div>

        <div class="music-controls">
            <button class="control-btn" onclick="previousTrack()">‚èÆ</button>
            <button class="control-btn play-btn" onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button class="control-btn" onclick="nextTrack()">‚è≠</button>
        </div>

        <div class="volume-container">
            <span style="font-size: 1.2em;">üîä</span>
            <div class="volume-slider" onclick="changeVolume(event)">
                <div class="volume-level" id="volumeLevel"></div>
            </div>
            <span style="font-size: 1.2em;">üîà</span>
        </div>

        <div class="track-list" id="trackList">
            <div class="track-item active" onclick="playTrack(0)">Voice of Nature</div>
            <div class="track-item" onclick="playTrack(1)">Relaxing Flute</div>
            <div class="track-item" onclick="playTrack(2)">Flute Music</div>
            <div class="track-item" onclick="playTrack(3)">Japanese Calm Music</div>
        </div>

        <!-- Small debug area (hidden by default but useful during testing) -->
        <div id="audioDebug" style="display:none; margin-top:10px; color:#fff; font-size:0.9em;"></div>
    </div>
</div>

<!-- Visualization Overlay -->
<div class="visualization-container" id="visualization">
    <div class="close-btn" onclick="closeVisualization()">√ó</div>
    <h2>Guided Visualization</h2>

    <div class="visualization-scene">
        <img src="backgrounds/beach.jpg" class="visualization-image active" id="scene1">
        <img src="backgrounds/forest.jpg" class="visualization-image" id="scene2">
        <img src="backgrounds/mountain.jpg" class="visualization-image" id="scene3">
        <img src="backgrounds/lake.jpg" class="visualization-image" id="scene4">
    </div>

    <div class="visualization-text" id="sceneText">
        Close your eyes and imagine yourself on a peaceful beach. Feel the warm sand beneath your feet and hear the gentle waves...
    </div>

    <div class="scene-controls">
        <button onclick="previousScene()">‚¨Ö Previous</button>
        <button onclick="nextScene()">Next ‚û°</button>
        <button onclick="closeVisualization()">Finish Journey</button>
    </div>
</div>

<script>
/* =========================
   Score & Categories
   ========================= */
const score = parseInt(localStorage.getItem("neuroity_score")) || 0;
document.getElementById("scoreDisplay").innerText = `${score}/120`;

const categories = [
    { min: 0, max: 30, name: "Optimal State", color: "#4CAF50",
      description: "You're in great mental shape! Keep maintaining your healthy habits." },
    { min: 31, max: 60, name: "Balanced", color: "#FFC107",
      description: "You're doing well overall with some areas for improvement." },
    { min: 61, max: 90, name: "Moderate Stress", color: "#FF9800",
      description: "You're experiencing noticeable stress. Time for some self-care." },
    { min: 91, max: 120, name: "High Stress", color: "#F44336",
      description: "You're under significant stress. Please prioritize relaxation." }
];

let userCategory = categories[0];
for (const cat of categories) {
    if (score >= cat.min && score <= cat.max) {
        userCategory = cat;
        break;
    }
}
const categoryElement = document.getElementById("resultCategory");
categoryElement.innerText = userCategory.name;
categoryElement.style.color = userCategory.color;
document.getElementById("categoryDescription").innerText = userCategory.description;

/* =========================
   Background management
   ========================= */
let currentBg = 0;
function initBackgrounds() {
    document.getElementById('bg1').classList.add('active');
    const thumbnails = document.querySelectorAll('.bg-thumbnail');
    if (thumbnails[0]) thumbnails[0].classList.add('active');

    setInterval(() => {
        changeBackground((currentBg + 1) % 4);
    }, 30000);
}
function changeBackground(index) {
    document.querySelectorAll('.background-image').forEach(bg => bg.classList.remove('active'));
    document.querySelectorAll('.bg-thumbnail').forEach(thumb => thumb.classList.remove('active'));

    const bgEl = document.getElementById(`bg${index + 1}`);
    if (bgEl) bgEl.classList.add('active');
    const thumbs = document.querySelectorAll('.bg-thumbnail');
    if (thumbs[index]) thumbs[index].classList.add('active');

    currentBg = index;
}

/* =========================
   Save Results
   ========================= */
function saveResults() {
    const name = document.getElementById("userName").value.trim();
    const age = document.getElementById("userAge").value.trim();

    if (!name || !age) {
        alert("Please enter both name and age.");
        return;
    }

    const userData = {
        name: name,
        age: Number(age),
        score: score,
        category: userCategory.name,
        date: new Date().toLocaleString()
    };

    // Get existing results
    let results = JSON.parse(localStorage.getItem("neuroity_results")) || [];

    // Save new result
    results.push(userData);

    // Store back
    localStorage.setItem("neuroity_results", JSON.stringify(results));

    // UI updates
    document.querySelector(".user-form").style.display = "none";
    document.getElementById("exerciseSection").classList.remove("hidden");

    const btn = document.getElementById("saveBtn");
    btn.innerText = "‚úÖ Results Saved";
    btn.style.background = "#4CAF50";
    btn.disabled = true;

    alert("Your results have been saved successfully!");
}


/* =========================
   Breathing exercise
   ========================= */
let breathingInterval;
let breathPhase = 'inhale';
let breathTime = 0;
let isBreathingActive = false;
let totalBreathTime = 0;
const breathCycles = { inhale: 4, hold: 7, exhale: 8 };

function startBreathingExercise() {
    const container = document.getElementById("breathingExercise");
    container.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    const hour = new Date().getHours();
    document.getElementById("breathingBg").src = (hour >= 6 && hour < 18) ? "backgrounds/beach.jpg" : "backgrounds/stars.jpg";

    startBreathingCycle();
}
function startBreathingCycle() {
    isBreathingActive = true;
    breathTime = 0;
    totalBreathTime = 0;
    updateBreathing();
    clearInterval(breathingInterval);
    breathingInterval = setInterval(updateBreathing, 1000);
}
function updateBreathing() {
    breathTime++;
    totalBreathTime++;

    const minutes = Math.floor(totalBreathTime / 60).toString().padStart(2, '0');
    const seconds = (totalBreathTime % 60).toString().padStart(2, '0');
    document.getElementById("breathTimer").textContent = `${minutes}:${seconds}`;

    if (breathTime <= breathCycles.inhale) {
        breathPhase = 'inhale';
        document.getElementById("breathInstruction").textContent = "Breathe IN slowly...";
        document.getElementById("breathText").textContent = "INHALE";
    } else if (breathTime <= breathCycles.inhale + breathCycles.hold) {
        breathPhase = 'hold';
        document.getElementById("breathInstruction").textContent = "Hold your breath...";
        document.getElementById("breathText").textContent = "HOLD";
    } else if (breathTime <= breathCycles.inhale + breathCycles.hold + breathCycles.exhale) {
        breathPhase = 'exhale';
        document.getElementById("breathInstruction").textContent = "Breathe OUT slowly...";
        document.getElementById("breathText").textContent = "EXHALE";
    } else {
        breathTime = 0;
        breathPhase = 'inhale';
        document.getElementById("breathInstruction").textContent = "Breathe IN slowly...";
        document.getElementById("breathText").textContent = "INHALE";
    }

    const circle = document.getElementById("breathCircle");
    let scale;
    if (breathPhase === 'inhale') {
        scale = 0.8 + (0.7 * (breathTime / breathCycles.inhale));
    } else if (breathPhase === 'hold') {
        scale = 1.5;
    } else {
        const exhaleTime = breathTime - breathCycles.inhale - breathCycles.hold;
        scale = 1.5 - (0.7 * (exhaleTime / breathCycles.exhale));
    }
    circle.style.transform = `scale(${scale})`;
}
function pauseBreathing() {
    const pauseBtn = document.getElementById("pauseBtn");
    if (isBreathingActive) {
        clearInterval(breathingInterval);
        pauseBtn.innerHTML = '‚ñ∂ Resume';
        isBreathingActive = false;
    } else {
        breathingInterval = setInterval(updateBreathing, 1000);
        pauseBtn.innerHTML = '‚è∏ Pause';
        isBreathingActive = true;
    }
}
function resetBreathing() {
    clearInterval(breathingInterval);
    breathTime = 0;
    totalBreathTime = 0;
    document.getElementById("breathTimer").textContent = "00:00";
    document.getElementById("breathCircle").style.transform = "scale(0.8)";
    document.getElementById("breathInstruction").textContent = "Breathe IN";
    document.getElementById("breathText").textContent = "INHALE";
    if (isBreathingActive) startBreathingCycle();
}
function closeBreathingExercise() {
    clearInterval(breathingInterval);
    document.getElementById("breathingExercise").style.display = 'none';
    document.body.style.overflow = 'auto';
    isBreathingActive = false;
}

/* =========================
   Music Player (Fixed)
   ========================= */
/* Playlist uses Option A structure: ./music/Music1.mp3 etc. */
// Define your 4 music tracks with correct paths
const playlist = [
    {
        title: "Peaceful Morning",
        artist: "Morning Meditation Music",
        image: "backgrounds/sunset.jpg",
        file: "./music/Music1.mp3.mp4"
    },
    {
        title: "Flute Music",
        artist: "Spiritual Peace",
        image: "backgrounds/forest.jpg",
        file: "./music/Music2.mp3.mp4"
    },
    {
        title: "Calm Tune",
        artist: "Flute Music",
        image: "backgrounds/beach.jpg",
        file: "./music/Music3.mp3.mp4"
    },
    {
        title: "Meditation",
        artist: "Japanese Music",
        image: "backgrounds/stars.jpg",
        file: "./music/Music4.mp3.mp4"
    }
];

// Audio object
let audio = new Audio();
let isPlaying = false;
let currentTrack = 0;
let isInitialized = false;

// Initialize audio properties
function initAudioPlayer() {
    if (isInitialized) return;
    isInitialized = true;

    audio.preload = 'auto';
    audio.volume = 0.7;

    audio.addEventListener('loadedmetadata', updateDuration);
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('ended', () => {
        nextTrack();
    });
    audio.addEventListener('play', () => {
        isPlaying = true; document.getElementById("playBtn").innerHTML = "‚è∏";
        debug("Audio playing");
    });
    audio.addEventListener('pause', () => {
        isPlaying = false; document.getElementById("playBtn").innerHTML = "‚ñ∂";
        debug("Audio paused");
    });
    audio.addEventListener('error', (e) => {
        debug(`Audio error code=${e.target.error?.code}`);
        alert("Audio error loading file: " + audio.src);
        console.error("Audio error:", e);
    });
}

// Debug helper
function debug(msg) {
    const el = document.getElementById("audioDebug");
    if (el) {
        el.style.display = 'block';
        el.textContent = msg;
    }
    console.log(msg);
}

// Open music overlay
function showMusicPlayer() {
    document.getElementById("musicPlayer").style.display = 'flex';
    document.body.style.overflow = 'hidden';
    initAudioPlayer();
    loadTrack(currentTrack);
}

// Load track by index
function loadTrack(index) {
    if (index < 0 || index >= playlist.length) index = 0;
    currentTrack = index;
    const t = playlist[index];

    document.getElementById("musicTitle").textContent = t.title;
    document.getElementById("musicArtist").textContent = t.artist;
    document.getElementById("albumImage").src = t.image;

    document.querySelectorAll('.track-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
    });

    // Stop existing audio gracefully
    try { audio.pause(); } catch(e){/*ignore*/}

    audio.src = t.file;
    audio.load();

    // Error handler: give clear message if file missing
    audio.onerror = () => {
        debug("Failed to load audio: " + audio.src);
        alert("Audio file not found or cannot be loaded: " + audio.src + "\nMake sure the file exists in ./music/ and the filename matches exactly (case-sensitive).");
    };

    // If it was playing, try to resume
    if (isPlaying) {
        // attempt play with retry (user interaction may be required by browser)
        setTimeout(() => playAudioWithRetry(0), 200);
    }
}

// Play with simple retry logic
function playAudioWithRetry(retry = 0) {
    audio.play().then(() => {
        isPlaying = true;
        document.getElementById("playBtn").innerHTML = "‚è∏";
        debug("Playback started successfully.");
    }).catch(err => {
        debug("Play failed: " + (err?.message || err) + " (attempt " + (retry+1) + ")");
        if (retry < 2) {
            // try again a couple times
            setTimeout(() => playAudioWithRetry(retry + 1), 500);
        } else {
            // most browsers require a user gesture to start audio: inform user
            alert("Playback blocked by browser. Please click the play button to start audio.");
            isPlaying = false;
        }
    });
}

function togglePlay() {
    debug("togglePlay clicked");
    if (!audio.src) {
        loadTrack(currentTrack);
        setTimeout(() => togglePlay(), 300);
        return;
    }
    if (isPlaying) {
        audio.pause();
    } else {
        playAudioWithRetry();
    }
}

function previousTrack() {
    currentTrack = (currentTrack - 1 + playlist.length) % playlist.length;
    loadTrack(currentTrack);
    // auto play
    setTimeout(() => playAudioWithRetry(0), 200);
}

function nextTrack() {
    currentTrack = (currentTrack + 1) % playlist.length;
    loadTrack(currentTrack);
    setTimeout(() => playAudioWithRetry(0), 200);
}

function playTrack(index) {
    if (index >= 0 && index < playlist.length) {
        loadTrack(index);
        setTimeout(() => playAudioWithRetry(0), 200);
    }
}

function updateProgress() {
    if (audio.duration && !isNaN(audio.duration)) {
        const percent = (audio.currentTime / audio.duration) * 100;
        document.getElementById("progressBar").style.width = `${percent}%`;

        const m = Math.floor(audio.currentTime / 60);
        const s = Math.floor(audio.currentTime % 60).toString().padStart(2, '0');
        document.getElementById("currentTime").textContent = `${m}:${s}`;
    }
}

function updateDuration() {
    if (audio.duration && !isNaN(audio.duration)) {
        const m = Math.floor(audio.duration / 60);
        const s = Math.floor(audio.duration % 60).toString().padStart(2, '0');
        document.getElementById("duration").textContent = `${m}:${s}`;
    } else {
        document.getElementById("duration").textContent = "0:00";
    }
}

function seekMusic(event) {
    if (!audio.duration || isNaN(audio.duration)) return;
    const container = event.currentTarget;
    const clickX = event.offsetX;
    const width = container.offsetWidth;
    const ratio = Math.max(0, Math.min(1, clickX / width));
    audio.currentTime = ratio * audio.duration;
}

function changeVolume(event) {
    const slider = event.currentTarget;
    const clickX = event.offsetX;
    const width = slider.offsetWidth;
    const vol = Math.max(0, Math.min(1, clickX / width));
    audio.volume = vol;
    document.getElementById("volumeLevel").style.width = `${vol * 100}%`;
}

function closeMusicPlayer() {
    try { audio.pause(); } catch(e) {}
    isPlaying = false;
    document.getElementById("musicPlayer").style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById("audioDebug").style.display = 'none';
}

/* =========================
   Visualization
   ========================= */
let currentScene = 0;
const scenes = [
    { image: "backgrounds/beach.jpg", text: "Imagine yourself on a peaceful beach. Feel the warm sand beneath your feet, hear the gentle waves, and feel the ocean breeze on your skin. Take a deep breath and let the tension melt away." },
    { image: "backgrounds/forest.jpg", text: "Now, picture yourself walking through a serene forest. Sunlight filters through the leaves, birds are singing softly, and the air smells fresh and clean. Feel grounded and connected to nature." },
    { image: "backgrounds/mountain.jpg", text: "Visualize standing on a mountain peak. You can see for miles in every direction. The air is crisp and clear. Feel a sense of accomplishment and perspective wash over you." },
    { image: "backgrounds/lake.jpg", text: "Finally, imagine sitting by a calm lake. The water is perfectly still, reflecting the sky above. Watch as a leaf gently floats by. Feel completely at peace in this moment." }
];

function startVisualization() {
    const container = document.getElementById("visualization");
    container.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    loadScene(0);
    clearInterval(window.sceneInterval);
    window.sceneInterval = setInterval(nextScene, 45000);
}
function loadScene(index) {
    currentScene = index;
    scenes.forEach((s, i) => {
        const el = document.getElementById(`scene${i+1}`);
        if (el) el.classList.toggle('active', i === index);
    });
    document.getElementById("sceneText").textContent = scenes[index].text;
}
function nextScene() {
    loadScene((currentScene + 1) % scenes.length);
}
function previousScene() {
    loadScene((currentScene - 1 + scenes.length) % scenes.length);
}
function closeVisualization() {
    clearInterval(window.sceneInterval);
    document.getElementById("visualization").style.display = 'none';
    document.body.style.overflow = 'auto';
}

/* =========================
   Feeling check
   ========================= */
function recordFeeling(feeling) {
    const feedback = document.getElementById("feedbackMessage");
    feedback.style.display = 'block';

    let message = "", className = "";
    if (feeling === 'better') {
        message = "That's wonderful! Keep practicing these exercises daily for continued benefits.";
        className = "positive";
    } else if (feeling === 'same') {
        message = "That's okay! Consistency is key. Try different exercises to find what works best for you.";
        className = "positive";
    } else {
        message = "I'm sorry to hear that. Consider trying a different exercise or speaking with a professional.";
        className = "negative";
    }

    feedback.textContent = message;
    feedback.className = `feedback-message ${className}`;

    let feedbackHistory = JSON.parse(localStorage.getItem("neuroity_feedback") || "[]");
    feedbackHistory.push({ feeling, timestamp: new Date().toISOString(), score });
    localStorage.setItem("neuroity_feedback", JSON.stringify(feedbackHistory));

    setTimeout(() => {
        if (feeling === 'worse') {
            if (confirm("Would you like to try a different relaxation exercise?")) {
                showMusicPlayer();
            }
        }
    }, 1200);
}

/* =========================
   Utilities / Navigation
   ========================= */
function restartQuestionnaire() {
    if (confirm("Are you sure you want to retake the questionnaire?")) {
        window.location.href = "questionnaire.html";
    }
}
function viewAllResults() {
    window.location.href = "admin.html";
}

/* =========================
   Init on load
   ========================= */
window.onload = function() {
    // Auto-save anonymous results (local backup)
    let anonResults = JSON.parse(localStorage.getItem("neuroity_anonymous") || "[]");
    anonResults.push({ score, category: userCategory.name, timestamp: new Date().toISOString() });
    localStorage.setItem("neuroity_anonymous", JSON.stringify(anonResults));

    // Initialize backgrounds and thumbnails
    initBackgrounds();
};

</script>
</body>
</html>
